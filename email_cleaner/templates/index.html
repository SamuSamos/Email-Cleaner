<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Email Cleaner</title>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f3f4f6;
    padding: 30px;
}

.container {
    max-width: 750px;
    margin: auto;
    background: white;
    padding: 25px 30px;
    border-radius: 8px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.08);
}

h2 {
    margin-top: 0;
}

label {
    font-weight: bold;
    display: block;
    margin-top: 15px;
}

input[type="text"], select {
    width: 100%;
    padding: 8px;
    margin-top: 6px;
}

.options {
    display: flex;
    gap: 40px;
    margin-top: 15px;
}

.option {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: bold;
}

.buttons {
    margin-top: 20px;
}

button {
    padding: 8px 16px;
    font-size: 14px;
    cursor: pointer;
    margin-right: 10px;
}

progress {
    width: 100%;
    height: 18px;
    margin-top: 20px;
}

#logs {
    margin-top: 20px;
    background: #ffffff;
    border: 1px solid #ccc;
    height: 350px;
    overflow-y: auto;
    padding: 12px;
    white-space: pre-line;
    font-family: Consolas, monospace;
    font-size: 13px;
}
.status {
    margin-bottom: 10px;
}
</style>
</head>

<body>

<div class="container">
    <h2>üìß Email Cleaner</h2>

    {% if not connected %}
        <a href="/login">
            <button>üîê Se connecter √† Gmail</button>
        </a>
    {% else %}
        <div class="status">‚úÖ <b>Connect√© √† Gmail</b></div>

        <label>Dossier Gmail</label>
        <select id="label"></select>

        <label>Mots-cl√©s exp√©diteur</label>
        <input id="keywords" placeholder="amazon, caf, impots">

        <div class="options">
            <div class="option">
                <input type="checkbox" id="attachments" checked>
                <span>Conserver pi√®ces jointes</span>
            </div>

            <div class="option">
                <input type="checkbox" id="simulate" checked>
                <span>Mode simulation</span>
            </div>
        </div>

        <div class="buttons">
            <button onclick="start()">‚ñ∂ Lancer</button>
            <button onclick="stop()">‚ñ† Stop</button>
        </div>

        <progress id="progress" value="0" max="100"></progress>

        <div id="logs"></div>
    {% endif %}
</div>

<script>
const socket = io();
const logs = document.getElementById("logs");
const progress = document.getElementById("progress");

socket.on("log", msg => {
    logs.textContent += msg + "\n";
    logs.scrollTop = logs.scrollHeight;
});

socket.on("progress", p => progress.value = p);

function start() {
    logs.textContent = "";
    progress.value = 0;
    socket.emit("process_emails", {
        keywords: document.getElementById("keywords").value,
        keepAttachments: document.getElementById("attachments").checked,
        simulate: document.getElementById("simulate").checked,
        label: document.getElementById("label").value
    });
}

function stop() {
    socket.emit("stop");
}

fetch("/labels")
.then(r => r.json())
.then(labels => {
    const sel = document.getElementById("label");
    sel.innerHTML = `<option value="ALL">Tous les messages</option>`;
    labels.forEach(l => {
        sel.innerHTML += `<option value="${l.id}">${l.name}</option>`;
    });
});
</script>

</body>
</html>
